<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon IQ Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        h1 { text-align: center; margin-bottom: 8px; color: #1a1a2e; }
        .subtitle { text-align: center; color: #666; margin-bottom: 24px; font-size: 14px; }
        .container { max-width: 960px; margin: 0 auto; }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h2 { font-size: 18px; margin-bottom: 16px; color: #1a1a2e; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #555; }
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: #4a6cf7; }
        .row { display: flex; gap: 12px; align-items: flex-end; }
        .row > * { flex: 1; }
        .row > .small { flex: 0 0 120px; }
        button {
            background: #4a6cf7;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }
        button:hover { background: #3a5ce5; }
        button:disabled { background: #b0b8d1; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .progress-bar {
            background: #e9ecef;
            border-radius: 8px;
            height: 8px;
            margin: 12px 0;
            overflow: hidden;
        }
        .progress-bar .fill {
            background: #4a6cf7;
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s;
            width: 0%;
        }
        .status-text {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 8px;
        }
        .error { color: #dc3545; font-size: 13px; margin-top: 8px; }
        .hidden { display: none; }
        .report-content { font-size: 14px; line-height: 1.7; }
        .report-content h1 { text-align: left; font-size: 24px; margin: 20px 0 12px; }
        .report-content h2 { font-size: 20px; margin: 20px 0 10px; color: #1a1a2e; }
        .report-content h3 { font-size: 16px; margin: 16px 0 8px; }
        .report-content table { width: 100%; border-collapse: collapse; margin: 12px 0; }
        .report-content th, .report-content td {
            border: 1px solid #ddd; padding: 8px 12px; text-align: left; font-size: 13px;
        }
        .report-content th { background: #f8f9fa; font-weight: 600; }
        .report-content ul, .report-content ol { padding-left: 24px; margin: 8px 0; }
        .report-content p { margin: 8px 0; }
        .spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid #ddd; border-top-color: #4a6cf7;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            vertical-align: middle; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Tab Navigation --- */
        .tab-nav {
            display: flex; gap: 8px; justify-content: center;
            margin-bottom: 24px; flex-wrap: wrap;
        }
        .tab-btn {
            background: #fff; color: #555; border: 2px solid #e0e0e0;
            padding: 10px 24px; border-radius: 24px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; width: auto;
        }
        .tab-btn:hover { border-color: #4a6cf7; color: #4a6cf7; background: #f0f4ff; }
        .tab-btn.active { background: #4a6cf7; color: #fff; border-color: #4a6cf7; }
        .tab-btn.active:hover { background: #3a5ce5; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* --- Status Badges --- */
        .status-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .status-badge::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
        }
        .status-badge.pending { background: #f3f4f6; color: #6b7280; }
        .status-badge.pending::before { background: #9ca3af; }
        .status-badge.crawling { background: #dbeafe; color: #1d4ed8; }
        .status-badge.crawling::before { background: #3b82f6; animation: pulse-dot 1.5s infinite; }
        .status-badge.crawled { background: #dcfce7; color: #15803d; }
        .status-badge.crawled::before { background: #22c55e; }
        .status-badge.analyzing { background: #fef3c7; color: #a16207; }
        .status-badge.analyzing::before { background: #f59e0b; animation: pulse-dot 1.5s infinite; }
        .status-badge.analyzed { background: #ccfbf1; color: #0d9488; }
        .status-badge.analyzed::before { background: #14b8a6; }
        .status-badge.failed { background: #fee2e2; color: #dc2626; }
        .status-badge.failed::before { background: #ef4444; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* --- Small / Inline Buttons --- */
        .btn-sm {
            padding: 5px 14px; font-size: 12px; border-radius: 6px;
            width: auto; display: inline-block;
        }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }

        /* --- Site Cards --- */
        .site-card {
            background: #fff; border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #eef0f4;
            transition: box-shadow 0.2s, transform 0.15s;
        }
        .site-card:hover {
            box-shadow: 0 8px 32px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }
        .site-card-top {
            padding: 24px 28px 20px;
            border-bottom: 1px solid #f0f2f5;
            background: linear-gradient(135deg, #fafbff 0%, #f5f7fa 100%);
        }
        .site-card-header {
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        }
        .site-card-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700; color: #fff;
            background: linear-gradient(135deg, #4a6cf7, #7c3aed);
            flex-shrink: 0; text-transform: uppercase;
        }
        .site-card-info { flex: 1; min-width: 0; }
        .site-card-info .domain { font-size: 18px; font-weight: 700; color: #1a1a2e; letter-spacing: -0.3px; }
        .site-card-info .url-text { font-size: 13px; color: #9ca3af; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .site-card-meta {
            display: flex; gap: 12px; align-items: center; flex-shrink: 0;
        }
        .meta-chip {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
            background: #f0f4ff; color: #4a6cf7;
        }
        .meta-chip svg { width: 14px; height: 14px; }
        .site-card-body { padding: 20px 28px 24px; }
        .site-card-controls {
            display: flex; gap: 10px; align-items: flex-end;
            flex-wrap: wrap;
        }
        .site-card-controls input { width: 220px; margin-bottom: 0; }
        .site-card-controls button { width: auto; }
        .control-group {
            display: flex; gap: 10px; align-items: flex-end;
            flex-wrap: wrap; padding: 14px 0;
        }
        .control-group + .control-group { border-top: 1px solid #f0f2f5; }
        .control-label {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.8px; color: #9ca3af; margin-bottom: 6px;
        }

        /* --- Analysis History Cards --- */
        .analysis-history {
            margin-top: 4px; padding-top: 16px;
            border-top: 1px solid #f0f2f5;
        }
        .analysis-history-title {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.8px; color: #9ca3af; margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .analysis-history-title .count-badge {
            background: #e9ecef; color: #6c757d; font-size: 11px;
            padding: 1px 8px; border-radius: 10px; font-weight: 700;
        }
        .analysis-entry {
            display: flex; align-items: center; gap: 16px;
            padding: 14px 16px; margin-bottom: 8px;
            border-radius: 10px; background: #f8f9fc;
            border: 1px solid #eef0f4;
            transition: background 0.15s, border-color 0.15s;
        }
        .analysis-entry:hover { background: #f0f4ff; border-color: #d0d7f7; }
        .analysis-entry:last-child { margin-bottom: 0; }
        .analysis-entry-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; flex-shrink: 0;
            background: linear-gradient(135deg, #d2f4ea, #a7f3d0); color: #0d6e5e;
        }
        .analysis-entry-info { flex: 1; min-width: 0; }
        .analysis-entry-info .ae-company { font-size: 14px; font-weight: 600; color: #1a1a2e; }
        .analysis-entry-info .ae-meta {
            display: flex; gap: 16px; margin-top: 4px;
            font-size: 12px; color: #9ca3af; flex-wrap: wrap;
        }
        .analysis-entry-info .ae-meta span { display: inline-flex; align-items: center; gap: 4px; }
        .analysis-entry-actions { flex-shrink: 0; }

        /* --- Benchmark Inline Result --- */
        .benchmark-inline-result { margin-top: 20px; }

        @media (max-width: 600px) {
            .row { flex-direction: column; }
            .row > .small { flex: 1; }
            body { padding: 12px; }
            .card { padding: 16px; }
            .tab-nav { display: grid; grid-template-columns: 1fr 1fr; }
            .tab-btn { text-align: center; }
            .site-card-top { padding: 16px 18px 14px; }
            .site-card-body { padding: 14px 18px 18px; }
            .site-card-controls { flex-direction: column; }
            .site-card-controls input { width: 100%; }
            .site-card-controls button { width: 100%; }
            .site-card-meta { flex-wrap: wrap; }
            .analysis-entry { flex-direction: column; align-items: flex-start; gap: 10px; }
            .analysis-entry-info .ae-meta { flex-direction: column; gap: 4px; }
        }

        /* --- Dashboard Variables --- */
        :root { --color-a: #4a6cf7; --color-b: #f7844a; --color-tie: #adb5bd; }

        /* --- Hero Winner Banner --- */
        .hero-banner {
            background: linear-gradient(135deg, #4a6cf7, #7c3aed); color: #fff;
            border-radius: 12px; padding: 32px 24px; text-align: center;
            margin-bottom: 24px; animation: slideIn 0.6s ease-out;
        }
        .hero-banner .matchup { font-size: 14px; opacity: 0.85; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .hero-banner .scoreboard { font-size: 48px; font-weight: 800; margin: 12px 0; letter-spacing: 4px; }
        .hero-banner .winner-label { font-size: 20px; font-weight: 700; }
        .hero-banner .winner-label .trophy { font-size: 28px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Metric Cards --- */
        .metric-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .metric-card {
            background: #fff; border-radius: 10px; padding: 20px 16px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .metric-card .metric-value { font-size: 32px; font-weight: 800; color: #1a1a2e; }
        .metric-card .metric-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .metric-card .mini-bar { background: #e9ecef; border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; }
        .metric-card .mini-bar .mini-fill { height: 100%; border-radius: 4px; animation: growWidth 1s ease-out forwards; }
        @keyframes growWidth { from { width: 0%; } }

        /* --- Win Rate Bar --- */
        .winrate-bar-wrap { margin-bottom: 24px; }
        .winrate-bar-wrap h3 { font-size: 14px; color: #555; margin-bottom: 8px; font-weight: 600; }
        .winrate-bar { display: flex; height: 36px; border-radius: 8px; overflow: hidden; font-size: 12px; font-weight: 700; color: #fff; }
        .winrate-bar .seg { display: flex; align-items: center; justify-content: center; transition: width 1s ease-out; }
        .winrate-bar .seg-a { background: var(--color-a); }
        .winrate-bar .seg-tie { background: var(--color-tie); }
        .winrate-bar .seg-b { background: var(--color-b); }
        .winrate-legend { display: flex; gap: 20px; margin-top: 8px; font-size: 12px; color: #666; }
        .winrate-legend span::before { content: ''; display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 6px; vertical-align: middle; }
        .winrate-legend .leg-a::before { background: var(--color-a); }
        .winrate-legend .leg-tie::before { background: var(--color-tie); }
        .winrate-legend .leg-b::before { background: var(--color-b); }

        /* --- Sentiment Gauges --- */
        .sentiment-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .sentiment-card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .sentiment-card .sent-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .sentiment-card .sent-company { font-size: 16px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px; }
        .sentiment-card .sent-value { font-size: 28px; font-weight: 800; margin-bottom: 10px; }
        .sent-track { background: #e9ecef; border-radius: 4px; height: 10px; position: relative; }
        .sent-fill { height: 100%; border-radius: 4px; position: absolute; top: 0; transition: width 1s ease-out; }
        .sent-marker { position: absolute; top: -3px; width: 4px; height: 16px; background: #1a1a2e; border-radius: 2px; transform: translateX(-50%); transition: left 1s ease-out; }

        /* --- Category Breakdown --- */
        .category-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 24px; }
        .category-table th { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; padding: 8px 12px; text-align: left; border-bottom: 2px solid #e9ecef; }
        .category-table td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .category-table .cat-name { font-weight: 600; color: #333; text-transform: capitalize; }
        .cat-mini-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; min-width: 120px; }
        .cat-mini-bar .cat-seg-a { background: var(--color-a); }
        .cat-mini-bar .cat-seg-b { background: var(--color-b); }

        /* --- Perception Panels --- */
        .perception-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .perception-card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .perception-card h4 { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
        .perception-card .perc-section { margin-bottom: 10px; }
        .perception-card .perc-section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 6px; }
        .pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 2px 4px 2px 0; }
        .pill-green { background: #d4edda; color: #155724; }
        .pill-red { background: #f8d7da; color: #721c24; }

        /* --- Key Insights --- */
        .insights-box {
            background: #fffbeb; border-left: 4px solid #f59e0b;
            border-radius: 0 10px 10px 0; padding: 20px 24px; margin-bottom: 24px;
        }
        .insights-box .insights-header { font-size: 16px; font-weight: 700; color: #92400e; margin-bottom: 10px; }
        .insights-box ul { list-style: disc; padding-left: 20px; }
        .insights-box li { font-size: 14px; color: #78350f; margin-bottom: 6px; line-height: 1.5; }

        /* --- Accordion --- */
        .eval-accordion { margin-bottom: 24px; }
        .eval-item { background: #fff; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .eval-header {
            display: flex; align-items: center; gap: 10px; padding: 14px 18px;
            cursor: pointer; user-select: none; font-size: 14px;
        }
        .eval-header:hover { background: #f8f9fa; }
        .eval-header .eval-num { font-weight: 700; color: #555; min-width: 28px; }
        .eval-header .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-category { background: #e9ecef; color: #495057; }
        .badge-a { background: var(--color-a); color: #fff; }
        .badge-b { background: var(--color-b); color: #fff; }
        .badge-tie { background: var(--color-tie); color: #fff; }
        .eval-header .eval-prompt-preview { flex: 1; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .eval-header .chevron { font-size: 12px; color: #aaa; transition: transform 0.2s; }
        .eval-item.open .chevron { transform: rotate(90deg); }
        .eval-body { display: none; padding: 0 18px 18px; font-size: 13px; line-height: 1.7; }
        .eval-item.open .eval-body { display: block; }
        .eval-body .eval-section { margin-bottom: 12px; }
        .eval-body .eval-section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 4px; }
        .eval-body pre { background: #f5f7fa; border-radius: 8px; padding: 12px; overflow-x: auto; max-height: 300px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }

        /* --- Dashboard Responsive --- */
        @media (max-width: 700px) {
            .metric-cards { grid-template-columns: repeat(2, 1fr); }
            .sentiment-row, .perception-row { grid-template-columns: 1fr; }
            .hero-banner .scoreboard { font-size: 36px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align:center;margin-bottom:8px;">
            <h1 style="background:linear-gradient(135deg,#4a6cf7,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:28px;letter-spacing:-0.5px;">Falcon IQ Analyzer</h1>
        </div>
        <p class="subtitle">Crawl websites, analyze offerings, and benchmark competitive positioning</p>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('websites')">Websites</button>
            <button class="tab-btn" onclick="switchTab('benchmark')">Benchmark</button>
            <button class="tab-btn" onclick="switchTab('reports')">Reports</button>
        </div>

        <!-- Tab 1: Websites (add + crawl + analyze) -->
        <div class="tab-panel active" id="tab-websites">
            <div class="card" style="border: 2px dashed #d0d7f7; background: linear-gradient(135deg, #fafbff 0%, #f0f4ff 100%); box-shadow: none;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#4a6cf7,#7c3aed);display:flex;align-items:center;justify-content:center;">
                        <svg width="18" height="18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><line x1="9" y1="3" x2="9" y2="15"/><line x1="3" y1="9" x2="15" y2="9"/></svg>
                    </div>
                    <div>
                        <div style="font-size:16px;font-weight:700;color:#1a1a2e;">Add Website</div>
                        <div style="font-size:13px;color:#9ca3af;">Enter a URL to crawl and analyze</div>
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label for="addUrlInput">Website URL</label>
                        <input type="url" id="addUrlInput" placeholder="https://example.com" style="border-color:#d0d7f7;">
                    </div>
                    <div class="small">
                        <label for="addMaxPages">Max pages</label>
                        <input type="number" id="addMaxPages" value="100" min="1" max="10000" style="border-color:#d0d7f7;">
                    </div>
                    <div class="small" style="flex:0 0 100px;">
                        <label>&nbsp;</label>
                        <button onclick="addWebsite()" style="width:100%;padding:10px 0;border-radius:10px;">Add Site</button>
                    </div>
                </div>
            </div>
            <div id="siteCardsContainer">
                <div style="text-align:center;padding:48px 24px;color:#b0b8d1;">
                    <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">&#127760;</div>
                    <div style="font-size:15px;font-weight:600;color:#8890a4;">No websites yet</div>
                    <div style="font-size:13px;margin-top:4px;">Add a URL above or wait for previously crawled sites to load</div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Benchmark -->
        <div class="tab-panel" id="tab-benchmark">
            <!-- New Benchmark Card -->
            <div class="card" style="border: 2px dashed #d0d7f7; background: linear-gradient(135deg, #fafbff 0%, #f0f4ff 100%); box-shadow: none;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#4a6cf7,#7c3aed);display:flex;align-items:center;justify-content:center;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                    </div>
                    <div>
                        <div style="font-size:16px;font-weight:700;color:#1a1a2e;">New Benchmark</div>
                        <div style="font-size:13px;color:#9ca3af;">Compare how LLMs perceive two companies</div>
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label for="benchJobANew">Company A</label>
                        <select id="benchJobANew" style="border-color:#d0d7f7;">
                            <option value="">-- Select analysis --</option>
                        </select>
                    </div>
                    <div>
                        <label for="benchJobBNew">Company B</label>
                        <select id="benchJobBNew" style="border-color:#d0d7f7;">
                            <option value="">-- Select analysis --</option>
                        </select>
                    </div>
                    <div class="small">
                        <label for="numPromptsNew">Prompts</label>
                        <input type="number" id="numPromptsNew" value="15" min="1" max="50" style="border-color:#d0d7f7;">
                    </div>
                </div>
                <button id="benchmarkBtnNew" onclick="startBenchmarkNew()" style="border-radius:10px;">&#9656; Run Benchmark</button>

                <div id="benchmarkProgressNew" class="hidden" style="margin-top:16px;">
                    <div class="progress-bar"><div class="fill" id="benchmarkFillNew"></div></div>
                    <p class="status-text" id="benchmarkStatusNew"><span class="spinner"></span>Starting...</p>
                </div>
                <p class="error hidden" id="benchmarkErrorNew"></p>
            </div>

            <!-- Benchmark History -->
            <div id="benchmarkHistoryContainer">
                <div style="text-align:center;padding:40px 24px;color:#b0b8d1;">
                    <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">&#128202;</div>
                    <div style="font-size:15px;font-weight:600;color:#8890a4;">No benchmarks yet</div>
                    <div style="font-size:13px;margin-top:4px;">Run a benchmark above to compare two companies</div>
                </div>
            </div>

            <div id="benchmarkInlineResult" class="hidden benchmark-inline-result"></div>
        </div>

        <!-- Tab 3: Reports -->
        <div class="tab-panel" id="tab-reports">
            <div class="site-card">
                <div class="site-card-top">
                    <div class="site-card-header">
                        <div class="site-card-icon" style="background:linear-gradient(135deg,#28a745,#20c997);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        </div>
                        <div class="site-card-info">
                            <div class="domain">Reports</div>
                            <div class="url-text">View and download benchmark and analysis reports</div>
                        </div>
                    </div>
                </div>
                <div class="site-card-body">
                    <div class="row" style="align-items:flex-end;">
                        <div>
                            <label for="reportTypeSelect">Report type</label>
                            <select id="reportTypeSelect" onchange="onReportTypeChange()">
                                <option value="benchmark">Benchmark Reports</option>
                                <option value="analysis">Analysis Reports</option>
                            </select>
                        </div>
                        <div>
                            <label for="reportSelect">Select report</label>
                            <select id="reportSelect" onchange="onReportSelected()">
                                <option value="">-- Select a report --</option>
                            </select>
                        </div>
                        <div style="flex:0 0 auto;">
                            <label>&nbsp;</label>
                            <button class="btn-sm btn-success" onclick="downloadCurrentReport()" id="downloadReportBtn" disabled style="padding:10px 20px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="vertical-align:middle;margin-right:4px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="reportDisplayArea" class="hidden"></div>
        </div>
    </div>

<script>
    // =============================================
    // App State
    // =============================================
    const AppState = {
        sites: [],           // [{ url, domain, directory, page_count, status, maxPages }]
        crawlJobs: {},       // { siteIndex: { jobId, status, progress, progress_pct, error } }
        analyzeJobs: {},     // { siteIndex: { jobId, status, progress, progress_pct, result, companyName } }
        analyses: [],        // from GET /analyses
        benchmarks: [],      // from GET /benchmarks
        currentBenchmarkReport: null,
        currentAnalysisReport: null,
        activeTab: 'websites'
    };

    // =============================================
    // Tab Navigation
    // =============================================
    function switchTab(name) {
        AppState.activeTab = name;
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        const tabNames = ['websites', 'benchmark', 'reports'];
        const btns = document.querySelectorAll('.tab-btn');
        btns[tabNames.indexOf(name)].classList.add('active');
        onTabEnter(name);
    }

    function onTabEnter(name) {
        if (name === 'websites') {
            loadSitesFromAPI();
        } else if (name === 'benchmark') {
            refreshAnalysesList();
            refreshBenchmarksList();
        } else if (name === 'reports') {
            refreshBenchmarksList();
            refreshAnalysesList();
            onReportTypeChange();
        }
    }

    // =============================================
    // Websites Tab: Add, Crawl, Analyze — all inline
    // =============================================
    async function loadSitesFromAPI() {
        try {
            const res = await fetch('/sites');
            const sites = await res.json();
            sites.forEach(s => {
                const exists = AppState.sites.find(
                    existing => existing.domain === s.domain && existing.directory === s.directory
                );
                if (!exists) {
                    AppState.sites.push({
                        url: 'https://' + s.domain,
                        domain: s.domain,
                        directory: s.directory,
                        page_count: s.page_count,
                        status: 'crawled',
                        maxPages: s.page_count
                    });
                }
            });
        } catch (e) {
            console.error('Failed to load sites', e);
        }
        // Also fetch analyses to show per-site
        try {
            const res = await fetch('/analyses');
            AppState.analyses = await res.json();
        } catch (e) {
            console.error('Failed to load analyses', e);
        }
        renderSiteCards();
    }

    function addWebsite() {
        const urlInput = document.getElementById('addUrlInput');
        const maxInput = document.getElementById('addMaxPages');
        const url = urlInput.value.trim();
        if (!url) return alert('Please enter a URL');

        try { new URL(url); } catch { return alert('Please enter a valid URL'); }

        const domain = extractDomain(url);
        const exists = AppState.sites.find(s => s.domain === domain);
        if (exists) return alert('This domain is already in the list');

        const maxPages = parseInt(maxInput.value) || 100;
        AppState.sites.push({
            url,
            domain,
            directory: null,
            page_count: 0,
            status: 'pending',
            maxPages
        });
        urlInput.value = '';
        maxInput.value = '100';
        renderSiteCards();
    }

    async function removeSite(index) {
        if (AppState.crawlJobs[index] && AppState.crawlJobs[index].status === 'running') {
            return alert('Cannot remove a site that is currently being crawled');
        }
        if (AppState.analyzeJobs[index] && AppState.analyzeJobs[index].status === 'running') {
            return alert('Cannot remove a site that is currently being analyzed');
        }

        const site = AppState.sites[index];

        // Delete from backend if the site has been crawled
        if (site.status !== 'pending' && site.domain) {
            try {
                const res = await fetch(`/sites/${encodeURIComponent(site.domain)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    return alert('Failed to delete: ' + (data.detail || 'Unknown error'));
                }
            } catch (e) {
                return alert('Failed to delete: ' + e.message);
            }
        }

        AppState.sites.splice(index, 1);
        // Rebuild jobs maps with shifted indices
        const newCrawlJobs = {};
        const newAnalyzeJobs = {};
        for (const [k, v] of Object.entries(AppState.crawlJobs)) {
            const ki = parseInt(k);
            if (ki < index) newCrawlJobs[ki] = v;
            else if (ki > index) newCrawlJobs[ki - 1] = v;
        }
        for (const [k, v] of Object.entries(AppState.analyzeJobs)) {
            const ki = parseInt(k);
            if (ki < index) newAnalyzeJobs[ki] = v;
            else if (ki > index) newAnalyzeJobs[ki - 1] = v;
        }
        AppState.crawlJobs = newCrawlJobs;
        AppState.analyzeJobs = newAnalyzeJobs;
        renderSiteCards();
    }

    // ---- Render site cards with inline crawl/analyze controls ----
    function renderSiteCards() {
        const container = document.getElementById('siteCardsContainer');
        if (AppState.sites.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:48px 24px;color:#b0b8d1;">
                <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">&#127760;</div>
                <div style="font-size:15px;font-weight:600;color:#8890a4;">No websites yet</div>
                <div style="font-size:13px;margin-top:4px;">Add a URL above or wait for previously crawled sites to load</div>
            </div>`;
            return;
        }

        let html = '';
        AppState.sites.forEach((site, i) => {
            const crawlJob = AppState.crawlJobs[i] || {};
            const analyzeJob = AppState.analyzeJobs[i] || {};
            const initial = (site.domain || '?').replace(/^www\./, '').charAt(0).toUpperCase();

            html += `<div class="site-card" id="site-card-${i}">`;

            // ---- Card Top: Header ----
            html += `<div class="site-card-top">
                <div class="site-card-header">
                    <div class="site-card-icon">${escapeHtml(initial)}</div>
                    <div class="site-card-info">
                        <div class="domain">${escapeHtml(site.domain)}</div>
                        <div class="url-text">${escapeHtml(site.url)}</div>
                    </div>
                    <div class="site-card-meta">
                        <span class="status-badge ${site.status}">${site.status}</span>
                        ${site.page_count ? `<span class="meta-chip"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>${site.page_count} pages</span>` : ''}
                        <button class="btn-sm btn-danger" onclick="removeSite(${i})" style="padding:5px 12px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="vertical-align:middle;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                </div>
            </div>`;

            // ---- Card Body ----
            html += `<div class="site-card-body">`;

            // --- Crawl controls: always shown unless currently crawling/analyzing ---
            if (site.status !== 'crawling' && site.status !== 'analyzing') {
                const isCrawling = crawlJob.status === 'running';
                html += `<div class="control-group">
                    <div class="control-label">Crawl</div>
                    <div class="site-card-controls">
                        <input type="number" id="maxPages-${i}" value="${site.maxPages || 100}" min="1" max="10000" placeholder="Max pages" style="width:120px;">
                        <button class="btn-sm" onclick="startCrawlForSite(${i})" ${isCrawling ? 'disabled' : ''}>${isCrawling ? '<span class="spinner"></span> Crawling...' : '&#9656; Crawl'}</button>
                    </div>
                </div>`;
                if (crawlJob.error) {
                    html += `<p class="error">${escapeHtml(crawlJob.error)}</p>`;
                }
            }

            // --- Crawling in progress ---
            if (site.status === 'crawling') {
                html += `<div style="padding:8px 0;">
                    <div class="control-label">Crawling in progress</div>
                    <div class="progress-bar" style="margin:8px 0 4px;"><div class="fill" id="crawlFill-${i}" style="width:${crawlJob.progress_pct || 0}%"></div></div>
                    <p class="status-text" id="crawlStatus-${i}" style="text-align:left;margin-top:4px;"><span class="spinner"></span>${escapeHtml(crawlJob.progress || 'Crawling...')}</p>
                </div>`;
            }

            // --- Analyze controls: shown when crawled or analyzed ---
            if (site.status === 'crawled' || site.status === 'analyzed') {
                const isAnalyzing = analyzeJob.status === 'running';
                const defaultName = site.domain.replace(/^www\./, '').split('.')[0];
                const companyVal = analyzeJob.companyName || defaultName;

                html += `<div class="control-group">
                    <div class="control-label">Analyze</div>
                    <div class="site-card-controls">
                        <input type="text" id="companyName-${i}" value="${escapeHtml(companyVal)}" placeholder="Company name">
                        <button class="btn-sm btn-success" onclick="startAnalysisForSite(${i})" ${isAnalyzing ? 'disabled' : ''}>${isAnalyzing ? '<span class="spinner"></span> Analyzing...' : '&#9656; Analyze'}</button>
                    </div>
                </div>`;
                if (analyzeJob.error) {
                    html += `<p class="error">${escapeHtml(analyzeJob.error)}</p>`;
                }
            }

            // --- Analyzing in progress ---
            if (site.status === 'analyzing') {
                html += `<div style="padding:8px 0;">
                    <div class="control-label">Analysis in progress</div>
                    <div class="progress-bar" style="margin:8px 0 4px;"><div class="fill" id="analyzeFill-${i}" style="width:${analyzeJob.progress_pct || 0}%"></div></div>
                    <p class="status-text" id="analyzeStatus-${i}" style="text-align:left;margin-top:4px;"><span class="spinner"></span>${escapeHtml(analyzeJob.progress || 'Analyzing...')}</p>
                </div>`;
            }

            // --- Analysis result from current session: collapsible ---
            if (analyzeJob.result && analyzeJob.result.markdown_report) {
                html += `<details style="margin-top:12px;padding:12px 16px;background:#f0f4ff;border-radius:10px;border:1px solid #d0d7f7;">
                    <summary style="cursor:pointer;font-size:13px;font-weight:600;color:#4a6cf7;list-style:none;display:flex;align-items:center;gap:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4a6cf7" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
                        View Latest Analysis Report
                    </summary>
                    <div class="report-content" style="margin-top:12px;padding-top:12px;border-top:1px solid #d0d7f7;">${marked.parse(analyzeJob.result.markdown_report)}</div>
                </details>`;
            }

            // --- Past analyses: card-style entries ---
            const siteDomain = (site.domain || '').replace(/^www\./, '').toLowerCase();
            const siteAnalyses = AppState.analyses.filter(a => {
                // Match by domain field (most reliable)
                if (a.domain && siteDomain) {
                    const aDomain = a.domain.replace(/^www\./, '').toLowerCase();
                    if (aDomain === siteDomain) return true;
                }
                // Try directory match
                if (directoriesMatch(a.crawl_directory, site.directory)) return true;
                // Fallback: crawl_directory path contains the domain
                if (!siteDomain) return false;
                const crawlDir = (a.crawl_directory || '').toLowerCase();
                return crawlDir.includes(siteDomain);
            });
            if (siteAnalyses.length > 0) {
                html += `<div class="analysis-history">
                    <div class="analysis-history-title">
                        Analysis History <span class="count-badge">${siteAnalyses.length}</span>
                    </div>`;
                siteAnalyses.forEach(a => {
                    const dateStr = a.created_at ? new Date(a.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) : '—';
                    const timeStr = a.created_at ? new Date(a.created_at).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) : '';
                    html += `<div class="analysis-entry">
                        <div class="analysis-entry-icon">&#128202;</div>
                        <div class="analysis-entry-info">
                            <div class="ae-company">${escapeHtml(a.company_name)}</div>
                            <div class="ae-meta">
                                <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> ${dateStr} ${timeStr}</span>
                                <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg> ${a.total_pages || '—'} pages</span>
                                <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg> ${a.product_pages_analyzed || '—'} products</span>
                                <span style="color:#ccc;font-size:11px;">${escapeHtml(a.job_id)}</span>
                            </div>
                        </div>
                        <div class="analysis-entry-actions">
                            <button class="btn-sm btn-danger" onclick="deleteAnalysis('${escapeHtml(a.job_id)}')" title="Delete analysis" style="padding:6px 10px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }

            html += `</div>`; // close site-card-body
            html += `</div>`; // close site-card
        });
        container.innerHTML = html;
    }

    // ---- Crawl ----
    async function startCrawlForSite(i) {
        const site = AppState.sites[i];
        if (!site) return;

        // Read max pages from the per-site input
        const maxPagesInput = document.getElementById(`maxPages-${i}`);
        const maxPages = maxPagesInput ? (parseInt(maxPagesInput.value) || 100) : (site.maxPages || 100);
        site.maxPages = maxPages;

        site.status = 'crawling';
        AppState.crawlJobs[i] = { jobId: null, status: 'running', progress: 'Starting crawl...', progress_pct: 5, error: null };
        renderSiteCards();

        try {
            const res = await fetch('/crawl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: site.url, max_pages: maxPages }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Crawl failed');

            AppState.crawlJobs[i].jobId = data.job_id;
            pollCrawlForSite(i, data.job_id);
        } catch (e) {
            site.status = 'failed';
            AppState.crawlJobs[i] = { jobId: null, status: 'failed', progress: '', progress_pct: 0, error: e.message };
            renderSiteCards();
        }
    }

    function pollCrawlForSite(i, jobId) {
        const site = AppState.sites[i];
        const poll = async () => {
            try {
                const res = await fetch(`/crawl/${jobId}`);
                const data = await res.json();

                const pct = site.maxPages > 0 ? Math.min(95, (data.page_count / site.maxPages) * 100) : 10;
                AppState.crawlJobs[i].progress = data.progress || data.status;
                AppState.crawlJobs[i].progress_pct = data.status === 'completed' ? 100 : pct;

                // Update inline progress without full re-render
                const fillEl = document.getElementById(`crawlFill-${i}`);
                const statusEl = document.getElementById(`crawlStatus-${i}`);
                if (fillEl) fillEl.style.width = AppState.crawlJobs[i].progress_pct + '%';
                if (statusEl) statusEl.innerHTML = '<span class="spinner"></span>' + escapeHtml(AppState.crawlJobs[i].progress);

                if (data.status === 'completed') {
                    site.status = 'crawled';
                    site.directory = data.output_dir;
                    site.page_count = data.page_count;
                    AppState.crawlJobs[i].status = 'completed';
                    renderSiteCards();
                    return;
                }
                if (data.status === 'failed') {
                    site.status = 'failed';
                    AppState.crawlJobs[i] = { jobId, status: 'failed', progress: '', progress_pct: 0, error: data.error || 'Crawl failed' };
                    renderSiteCards();
                    return;
                }
                setTimeout(poll, 2000);
            } catch (e) {
                AppState.crawlJobs[i].error = e.message;
                renderSiteCards();
            }
        };
        setTimeout(poll, 2000);
    }

    // ---- Analyze ----
    async function startAnalysisForSite(i) {
        const site = AppState.sites[i];
        if (!site || !site.directory) return alert('Site has not been crawled yet');

        const nameInput = document.getElementById(`companyName-${i}`);
        const companyName = nameInput ? nameInput.value.trim() : '';
        if (!companyName) return alert('Please enter a company name');

        site.status = 'analyzing';
        AppState.analyzeJobs[i] = { jobId: null, status: 'running', progress: 'Starting analysis...', progress_pct: 5, result: null, companyName, error: null };
        renderSiteCards();

        try {
            const res = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    crawl_directory: site.directory,
                    company_name: companyName,
                    domain: site.domain,
                }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Analysis failed');

            AppState.analyzeJobs[i].jobId = data.job_id;
            pollAnalysisForSite(i, data.job_id);
        } catch (e) {
            site.status = 'crawled';
            AppState.analyzeJobs[i] = { jobId: null, status: 'failed', progress: '', progress_pct: 0, result: null, companyName, error: e.message };
            renderSiteCards();
        }
    }

    function pollAnalysisForSite(i, jobId) {
        const stepPattern = /step\s*(\d+)/i;
        const poll = async () => {
            try {
                const res = await fetch(`/analyze/${jobId}`);
                const data = await res.json();

                let pct = 10;
                if (data.progress) {
                    const match = data.progress.match(stepPattern);
                    if (match) pct = Math.min(95, (parseInt(match[1]) / 6) * 100);
                }

                AppState.analyzeJobs[i].progress = data.progress || data.status;
                AppState.analyzeJobs[i].progress_pct = data.status === 'completed' ? 100 : pct;

                const fillEl = document.getElementById(`analyzeFill-${i}`);
                const statusEl = document.getElementById(`analyzeStatus-${i}`);
                if (fillEl) fillEl.style.width = AppState.analyzeJobs[i].progress_pct + '%';
                if (statusEl) statusEl.innerHTML = '<span class="spinner"></span>' + escapeHtml(AppState.analyzeJobs[i].progress);

                if (data.status === 'completed') {
                    AppState.sites[i].status = 'analyzed';
                    AppState.analyzeJobs[i].status = 'completed';
                    AppState.analyzeJobs[i].result = data.result;
                    await refreshAnalysesList();
                    renderSiteCards();
                    return;
                }
                if (data.status === 'failed') {
                    AppState.sites[i].status = 'crawled';
                    AppState.analyzeJobs[i] = {
                        jobId, status: 'failed', progress: '', progress_pct: 0,
                        result: null, companyName: AppState.analyzeJobs[i].companyName,
                        error: data.error || 'Analysis failed'
                    };
                    renderSiteCards();
                    return;
                }
                setTimeout(poll, 3000);
            } catch (e) {
                AppState.analyzeJobs[i].error = e.message;
                renderSiteCards();
            }
        };
        setTimeout(poll, 3000);
    }

    // ---- Delete Analysis ----
    async function deleteAnalysis(jobId) {
        if (!confirm('Delete this analysis? This cannot be undone.')) return;
        try {
            const res = await fetch(`/analyses/${encodeURIComponent(jobId)}`, { method: 'DELETE' });
            if (!res.ok) {
                const data = await res.json();
                return alert('Failed to delete: ' + (data.detail || 'Unknown error'));
            }
            // Remove from AppState and re-render
            AppState.analyses = AppState.analyses.filter(a => a.job_id !== jobId);
            renderSiteCards();
            refreshAnalysesList();
        } catch (e) {
            alert('Failed to delete: ' + e.message);
        }
    }

    // =============================================
    // Benchmark Tab
    // =============================================
    async function refreshAnalysesList() {
        try {
            const res = await fetch('/analyses');
            AppState.analyses = await res.json();
        } catch (e) {
            console.error('Failed to load analyses', e);
            return;
        }
        const selA = document.getElementById('benchJobANew');
        const selB = document.getElementById('benchJobBNew');
        if (selA && selB) {
            const defaultOpt = '<option value="">-- Select analysis --</option>';
            selA.innerHTML = defaultOpt;
            selB.innerHTML = defaultOpt;
            AppState.analyses.forEach(a => {
                const html = `<option value="${escapeHtml(a.job_id)}">${escapeHtml(a.company_name)} (${escapeHtml(a.job_id)})</option>`;
                selA.innerHTML += html;
                selB.innerHTML += html;
            });
        }
    }

    async function refreshBenchmarksList() {
        try {
            const res = await fetch('/benchmarks');
            AppState.benchmarks = await res.json();
        } catch (e) {
            console.error('Failed to load benchmarks', e);
            return;
        }
        renderBenchmarkHistory();
        const reportType = document.getElementById('reportTypeSelect');
        if (reportType && reportType.value === 'benchmark') {
            populateReportDropdown();
        }
    }

    function renderBenchmarkHistory() {
        const container = document.getElementById('benchmarkHistoryContainer');
        if (!container) return;

        if (AppState.benchmarks.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:40px 24px;color:#b0b8d1;">
                <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">&#128202;</div>
                <div style="font-size:15px;font-weight:600;color:#8890a4;">No benchmarks yet</div>
                <div style="font-size:13px;margin-top:4px;">Run a benchmark above to compare two companies</div>
            </div>`;
            return;
        }

        let html = `<div class="site-card">
            <div class="site-card-top">
                <div class="site-card-header">
                    <div class="site-card-icon" style="background:linear-gradient(135deg,#f7844a,#e74c3c);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                    </div>
                    <div class="site-card-info">
                        <div class="domain">Benchmark History</div>
                        <div class="url-text">${AppState.benchmarks.length} completed benchmark${AppState.benchmarks.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            </div>
            <div class="site-card-body">`;

        AppState.benchmarks.forEach(b => {
            const aW = b.company_a_wins || 0;
            const bW = b.company_b_wins || 0;
            const scoreStr = `${aW} — ${bW}`;
            let winnerHtml = '';
            if (aW > bW) winnerHtml = `<span style="color:#22c55e;font-weight:700;font-size:12px;">&#127942; ${escapeHtml(b.company_a)} wins</span>`;
            else if (bW > aW) winnerHtml = `<span style="color:#22c55e;font-weight:700;font-size:12px;">&#127942; ${escapeHtml(b.company_b)} wins</span>`;
            else winnerHtml = `<span style="color:#9ca3af;font-weight:600;font-size:12px;">Tie</span>`;
            const dateStr = b.created_at ? new Date(b.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) : '';

            html += `<div class="analysis-entry" style="cursor:pointer;" onclick="loadExistingBenchmarkNew('${escapeHtml(b.job_id)}')">
                <div class="analysis-entry-icon" style="background:linear-gradient(135deg,#fde6d8,#fdd0b5);color:#e74c3c;">&#9878;</div>
                <div class="analysis-entry-info">
                    <div class="ae-company">${escapeHtml(b.company_a)} vs ${escapeHtml(b.company_b)}</div>
                    <div class="ae-meta">
                        <span style="font-weight:700;color:#1a1a2e;">${scoreStr}</span>
                        ${winnerHtml}
                        <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg> ${b.total_prompts} prompts</span>
                        ${dateStr ? `<span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> ${dateStr}</span>` : ''}
                        <span style="color:#ccc;font-size:11px;">${escapeHtml(b.job_id)}</span>
                    </div>
                </div>
                <div class="analysis-entry-actions" style="display:flex;gap:8px;">
                    <button class="btn-sm" onclick="event.stopPropagation();loadExistingBenchmarkNew('${escapeHtml(b.job_id)}')" style="padding:6px 12px;font-size:11px;">View</button>
                    <button class="btn-sm btn-danger" onclick="event.stopPropagation();deleteBenchmark('${escapeHtml(b.job_id)}')" title="Delete benchmark" style="padding:6px 10px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    </button>
                </div>
            </div>`;
        });

        html += `</div></div>`;
        container.innerHTML = html;
    }

    async function loadExistingBenchmarkNew(jobId) {
        if (!jobId) {
            document.getElementById('benchmarkInlineResult').classList.add('hidden');
            return;
        }
        try {
            const res = await fetch(`/benchmark/${jobId}`);
            const data = await res.json();
            if (data.status === 'completed' && data.result) {
                const container = document.getElementById('benchmarkInlineResult');
                if (data.result.summary) {
                    renderBenchmarkDashboard(data.result, 'benchmarkInlineResult');
                } else if (data.result.markdown_report) {
                    container.innerHTML = `<div class="card"><div class="report-content">${marked.parse(data.result.markdown_report)}</div></div>`;
                }
                container.classList.remove('hidden');
                container.scrollIntoView({ behavior: 'smooth' });
            }
        } catch (e) {
            alert('Failed to load benchmark: ' + e.message);
        }
    }

    async function startBenchmarkNew() {
        const jobA = document.getElementById('benchJobANew').value;
        const jobB = document.getElementById('benchJobBNew').value;
        if (!jobA || !jobB) return alert('Please select both analyses');
        if (jobA === jobB) return alert('Please select two different analyses');

        const numPrompts = parseInt(document.getElementById('numPromptsNew').value) || 15;
        const btn = document.getElementById('benchmarkBtnNew');
        btn.disabled = true;
        showEl('benchmarkProgressNew');
        hideEl('benchmarkErrorNew');
        hideEl('benchmarkInlineResult');
        updateStatusText('benchmarkStatusNew', 'Starting benchmark...');
        updateFillWidth('benchmarkFillNew', 5);

        try {
            const res = await fetch('/benchmark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ job_id_a: jobA, job_id_b: jobB, num_prompts: numPrompts }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Benchmark failed');

            pollBenchmarkNew(data.job_id, numPrompts);
        } catch (e) {
            showErrorText('benchmarkErrorNew', e.message);
            btn.disabled = false;
            hideEl('benchmarkProgressNew');
        }
    }

    function pollBenchmarkNew(jobId, numPrompts) {
        const stepPattern = /Step\s+(\d+)\/(\d+)/;
        const poll = async () => {
            try {
                const res = await fetch(`/benchmark/${jobId}`);
                const data = await res.json();

                let pct = 10;
                if (data.progress) {
                    const match = data.progress.match(stepPattern);
                    if (match) pct = Math.min(95, (parseInt(match[1]) / parseInt(match[2])) * 100);
                }

                updateFillWidth('benchmarkFillNew', data.status === 'completed' ? 100 : pct);
                updateStatusText('benchmarkStatusNew', data.progress || data.status);

                if (data.status === 'completed') {
                    updateFillWidth('benchmarkFillNew', 100);
                    document.getElementById('benchmarkBtnNew').disabled = false;

                    if (data.result) {
                        const container = document.getElementById('benchmarkInlineResult');
                        if (data.result.summary) {
                            renderBenchmarkDashboard(data.result, 'benchmarkInlineResult');
                        } else if (data.result.markdown_report) {
                            container.innerHTML = `<div class="card"><div class="report-content">${marked.parse(data.result.markdown_report)}</div></div>`;
                        }
                        container.classList.remove('hidden');
                        container.scrollIntoView({ behavior: 'smooth' });
                        await refreshBenchmarksList();
                    }
                    return;
                }
                if (data.status === 'failed') {
                    showErrorText('benchmarkErrorNew', data.error || 'Benchmark failed');
                    document.getElementById('benchmarkBtnNew').disabled = false;
                    hideEl('benchmarkProgressNew');
                    return;
                }
                setTimeout(poll, 3000);
            } catch (e) {
                showErrorText('benchmarkErrorNew', e.message);
                document.getElementById('benchmarkBtnNew').disabled = false;
            }
        };
        setTimeout(poll, 3000);
    }

    // ---- Delete Benchmark ----
    async function deleteBenchmark(jobId) {
        if (!confirm('Delete this benchmark? This cannot be undone.')) return;
        try {
            const res = await fetch(`/benchmarks/${encodeURIComponent(jobId)}`, { method: 'DELETE' });
            if (!res.ok) {
                const data = await res.json();
                return alert('Failed to delete: ' + (data.detail || 'Unknown error'));
            }
            AppState.benchmarks = AppState.benchmarks.filter(b => b.job_id !== jobId);
            renderBenchmarkHistory();
            // Hide inline result if it was showing this benchmark
            document.getElementById('benchmarkInlineResult').classList.add('hidden');
        } catch (e) {
            alert('Failed to delete: ' + e.message);
        }
    }

    // =============================================
    // Reports Tab
    // =============================================
    function onReportTypeChange() {
        populateReportDropdown();
        document.getElementById('reportDisplayArea').classList.add('hidden');
        document.getElementById('reportDisplayArea').innerHTML = '';
        document.getElementById('downloadReportBtn').disabled = true;
        AppState.currentBenchmarkReport = null;
        AppState.currentAnalysisReport = null;
    }

    function populateReportDropdown() {
        const type = document.getElementById('reportTypeSelect').value;
        const sel = document.getElementById('reportSelect');
        sel.innerHTML = '<option value="">-- Select a report --</option>';

        if (type === 'benchmark') {
            AppState.benchmarks.forEach(b => {
                sel.innerHTML += `<option value="${escapeHtml(b.job_id)}">${escapeHtml(b.company_a)} vs ${escapeHtml(b.company_b)} (${b.total_prompts} prompts)</option>`;
            });
        } else {
            AppState.analyses.forEach(a => {
                sel.innerHTML += `<option value="${escapeHtml(a.job_id)}">${escapeHtml(a.company_name)} (${escapeHtml(a.job_id)})</option>`;
            });
        }
    }

    async function onReportSelected() {
        const type = document.getElementById('reportTypeSelect').value;
        const jobId = document.getElementById('reportSelect').value;
        const area = document.getElementById('reportDisplayArea');
        const dlBtn = document.getElementById('downloadReportBtn');

        if (!jobId) {
            area.classList.add('hidden');
            area.innerHTML = '';
            dlBtn.disabled = true;
            AppState.currentBenchmarkReport = null;
            AppState.currentAnalysisReport = null;
            return;
        }

        area.innerHTML = '<p style="text-align:center;padding:24px;"><span class="spinner"></span> Loading report...</p>';
        area.classList.remove('hidden');

        try {
            if (type === 'benchmark') {
                const res = await fetch(`/benchmark/${jobId}`);
                const data = await res.json();
                if (data.status === 'completed' && data.result) {
                    AppState.currentBenchmarkReport = data.result;
                    AppState.currentAnalysisReport = null;
                    if (data.result.summary) {
                        renderBenchmarkDashboard(data.result, 'reportDisplayArea');
                    } else if (data.result.markdown_report) {
                        area.innerHTML = `<div class="card"><div class="report-content">${marked.parse(data.result.markdown_report)}</div></div>`;
                    }
                    dlBtn.disabled = false;
                } else {
                    area.innerHTML = '<p style="text-align:center;color:#aaa;padding:24px;">Report not available.</p>';
                    dlBtn.disabled = true;
                }
            } else {
                const res = await fetch(`/analyze/${jobId}`);
                const data = await res.json();
                if (data.status === 'completed' && data.result && data.result.markdown_report) {
                    AppState.currentAnalysisReport = { jobId, markdown: data.result.markdown_report, companyName: data.result.company_name };
                    AppState.currentBenchmarkReport = null;
                    area.innerHTML = `<div class="card"><div class="report-content">${marked.parse(data.result.markdown_report)}</div></div>`;
                    dlBtn.disabled = false;
                } else {
                    area.innerHTML = '<p style="text-align:center;color:#aaa;padding:24px;">Report not available.</p>';
                    dlBtn.disabled = true;
                }
            }
        } catch (e) {
            area.innerHTML = `<p class="error" style="padding:24px;">Failed to load report: ${escapeHtml(e.message)}</p>`;
            dlBtn.disabled = true;
        }
    }

    function downloadCurrentReport() {
        if (AppState.currentBenchmarkReport) {
            const md = AppState.currentBenchmarkReport.markdown_report || '';
            if (!md) return alert('No markdown report available');
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'benchmark-report.md';
            a.click();
            URL.revokeObjectURL(a.href);
        } else if (AppState.currentAnalysisReport) {
            const md = AppState.currentAnalysisReport.markdown;
            if (!md) return alert('No markdown report available');
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${AppState.currentAnalysisReport.companyName || 'analysis'}-report.md`;
            a.click();
            URL.revokeObjectURL(a.href);
        }
    }

    // =============================================
    // Benchmark Dashboard Renderer (parameterized)
    // =============================================
    function renderBenchmarkDashboard(result, containerId) {
        const s = result.summary;
        const evals = result.evaluations || [];
        const cA = s.company_a;
        const cB = s.company_b;
        const total = s.total_prompts || 1;
        const aWins = s.company_a_wins;
        const bWins = s.company_b_wins;
        const ties = s.ties;
        const aPct = Math.round((aWins / total) * 100);
        const bPct = Math.round((bWins / total) * 100);
        const tPct = 100 - aPct - bPct;

        let winner;
        if (aWins > bWins) { winner = cA; }
        else if (bWins > aWins) { winner = cB; }
        else { winner = null; }

        let heroHTML = `<div class="hero-banner">
            <div class="matchup">${escapeHtml(cA)} vs ${escapeHtml(cB)}</div>
            <div class="scoreboard">${aWins} &mdash; ${bWins}</div>`;
        if (winner) {
            heroHTML += `<div class="winner-label"><span class="trophy">&#127942;</span> ${escapeHtml(winner)} WINS</div>`;
        } else {
            heroHTML += `<div class="winner-label">It's a Tie!</div>`;
        }
        heroHTML += `</div>`;

        const metricsHTML = `<div class="metric-cards">
            <div class="metric-card">
                <div class="metric-label">Total Prompts</div>
                <div class="metric-value">${total}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">${escapeHtml(cA)} Wins</div>
                <div class="metric-value" style="color:var(--color-a)">${aWins}</div>
                <div class="mini-bar"><div class="mini-fill" style="width:${aPct}%;background:var(--color-a)"></div></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">${escapeHtml(cB)} Wins</div>
                <div class="metric-value" style="color:var(--color-b)">${bWins}</div>
                <div class="mini-bar"><div class="mini-fill" style="width:${bPct}%;background:var(--color-b)"></div></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Ties</div>
                <div class="metric-value" style="color:var(--color-tie)">${ties}</div>
            </div>
        </div>`;

        const winrateHTML = `<div class="winrate-bar-wrap card">
            <h3>Win Rate Distribution</h3>
            <div class="winrate-bar">
                ${aPct > 0 ? `<div class="seg seg-a" style="width:${aPct}%">${aPct}%</div>` : ''}
                ${tPct > 0 ? `<div class="seg seg-tie" style="width:${tPct}%">${tPct}%</div>` : ''}
                ${bPct > 0 ? `<div class="seg seg-b" style="width:${bPct}%">${bPct}%</div>` : ''}
            </div>
            <div class="winrate-legend">
                <span class="leg-a">${escapeHtml(cA)}</span>
                <span class="leg-tie">Tie</span>
                <span class="leg-b">${escapeHtml(cB)}</span>
            </div>
        </div>`;

        function sentimentColor(v) {
            if (v >= 0.5) return '#22c55e';
            if (v >= 0.2) return '#84cc16';
            if (v >= -0.2) return '#eab308';
            if (v >= -0.5) return '#f97316';
            return '#ef4444';
        }
        function sentimentGauge(company, value) {
            const pct = ((value + 1) / 2) * 100;
            const col = sentimentColor(value);
            return `<div class="sentiment-card">
                <div class="sent-label">Avg Sentiment</div>
                <div class="sent-company">${escapeHtml(company)}</div>
                <div class="sent-value" style="color:${col}">${value.toFixed(2)}</div>
                <div class="sent-track">
                    <div class="sent-fill" style="width:${pct}%;background:linear-gradient(90deg,#ef4444,#eab308,#22c55e);opacity:0.3"></div>
                    <div class="sent-marker" style="left:${pct}%"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:11px;color:#aaa;margin-top:4px"><span>-1.0</span><span>0</span><span>+1.0</span></div>
            </div>`;
        }
        const sentimentHTML = `<div class="sentiment-row">
            ${sentimentGauge(cA, s.company_a_avg_sentiment)}
            ${sentimentGauge(cB, s.company_b_avg_sentiment)}
        </div>`;

        const categories = {};
        evals.forEach(ev => {
            const cat = ev.category || 'other';
            if (!categories[cat]) categories[cat] = { a: 0, b: 0, total: 0 };
            categories[cat].total++;
            if (ev.winner === 'company_a') categories[cat].a++;
            else if (ev.winner === 'company_b') categories[cat].b++;
        });
        let catRows = '';
        for (const [cat, counts] of Object.entries(categories)) {
            const catTotal = counts.total || 1;
            const aW = Math.round((counts.a / catTotal) * 100);
            const bW = Math.round((counts.b / catTotal) * 100);
            catRows += `<tr>
                <td class="cat-name">${escapeHtml(cat.replace(/_/g, ' '))}</td>
                <td>${counts.total}</td>
                <td>${counts.a}</td>
                <td>${counts.b}</td>
                <td><div class="cat-mini-bar">
                    <div class="cat-seg-a" style="width:${aW}%"></div>
                    <div class="cat-seg-b" style="width:${bW}%"></div>
                </div></td>
            </tr>`;
        }
        const categoryHTML = `<div class="card">
            <h3 style="font-size:14px;color:#555;margin-bottom:8px;font-weight:600">Category Breakdown</h3>
            <table class="category-table">
                <thead><tr><th>Category</th><th>Prompts</th><th>${escapeHtml(cA)}</th><th>${escapeHtml(cB)}</th><th>Distribution</th></tr></thead>
                <tbody>${catRows}</tbody>
            </table>
        </div>`;

        function pillList(items, cls) {
            if (!items || items.length === 0) return '<span style="font-size:12px;color:#aaa">None noted</span>';
            return items.map(i => `<span class="pill ${cls}">${escapeHtml(i)}</span>`).join('');
        }
        const perceptionHTML = `<div class="perception-row">
            <div class="perception-card" style="border-top:3px solid var(--color-a)">
                <h4 style="color:var(--color-a)">${escapeHtml(cA)}</h4>
                <div class="perc-section">
                    <div class="perc-section-label">Strengths</div>
                    ${pillList(s.company_a_top_strengths, 'pill-green')}
                </div>
                <div class="perc-section">
                    <div class="perc-section-label">Weaknesses</div>
                    ${pillList(s.company_a_top_weaknesses, 'pill-red')}
                </div>
            </div>
            <div class="perception-card" style="border-top:3px solid var(--color-b)">
                <h4 style="color:var(--color-b)">${escapeHtml(cB)}</h4>
                <div class="perc-section">
                    <div class="perc-section-label">Strengths</div>
                    ${pillList(s.company_b_top_strengths, 'pill-green')}
                </div>
                <div class="perc-section">
                    <div class="perc-section-label">Weaknesses</div>
                    ${pillList(s.company_b_top_weaknesses, 'pill-red')}
                </div>
            </div>
        </div>`;

        let insightsHTML = '';
        if (s.key_insights && s.key_insights.length > 0) {
            insightsHTML = `<div class="insights-box">
                <div class="insights-header">&#128161; Key Insights</div>
                <ul>${s.key_insights.map(i => `<li>${escapeHtml(i)}</li>`).join('')}</ul>
            </div>`;
        }

        let accordionHTML = '<div class="eval-accordion"><h3 style="font-size:14px;color:#555;margin-bottom:12px;font-weight:600">Detailed Evaluations</h3>';
        evals.forEach((ev, idx) => {
            const winBadge = ev.winner === 'company_a' ? `<span class="badge badge-a">${escapeHtml(cA)}</span>`
                : ev.winner === 'company_b' ? `<span class="badge badge-b">${escapeHtml(cB)}</span>`
                : `<span class="badge badge-tie">Tie</span>`;
            const mA = ev.company_a_mention || {};
            const mB = ev.company_b_mention || {};
            accordionHTML += `<div class="eval-item">
                <div class="eval-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="eval-num">#${idx + 1}</span>
                    <span class="badge badge-category">${escapeHtml((ev.category || '').replace(/_/g, ' '))}</span>
                    ${winBadge}
                    <span class="eval-prompt-preview">${escapeHtml(ev.prompt_text || '')}</span>
                    <span class="chevron">&#9654;</span>
                </div>
                <div class="eval-body">
                    <div class="eval-section">
                        <div class="eval-section-label">Prompt</div>
                        <p>${escapeHtml(ev.prompt_text || '')}</p>
                    </div>
                    <div class="eval-section" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div>
                            <div class="eval-section-label">${escapeHtml(cA)} Sentiment</div>
                            <strong style="color:${sentimentColor(mA.sentiment || 0)}">${(mA.sentiment || 0).toFixed(2)}</strong>
                            ${mA.strengths_mentioned && mA.strengths_mentioned.length ? '<br>' + mA.strengths_mentioned.map(x => `<span class="pill pill-green">${escapeHtml(x)}</span>`).join('') : ''}
                            ${mA.weaknesses_mentioned && mA.weaknesses_mentioned.length ? '<br>' + mA.weaknesses_mentioned.map(x => `<span class="pill pill-red">${escapeHtml(x)}</span>`).join('') : ''}
                        </div>
                        <div>
                            <div class="eval-section-label">${escapeHtml(cB)} Sentiment</div>
                            <strong style="color:${sentimentColor(mB.sentiment || 0)}">${(mB.sentiment || 0).toFixed(2)}</strong>
                            ${mB.strengths_mentioned && mB.strengths_mentioned.length ? '<br>' + mB.strengths_mentioned.map(x => `<span class="pill pill-green">${escapeHtml(x)}</span>`).join('') : ''}
                            ${mB.weaknesses_mentioned && mB.weaknesses_mentioned.length ? '<br>' + mB.weaknesses_mentioned.map(x => `<span class="pill pill-red">${escapeHtml(x)}</span>`).join('') : ''}
                        </div>
                    </div>
                    ${ev.analysis_notes ? `<div class="eval-section"><div class="eval-section-label">Analysis Notes</div><p>${escapeHtml(ev.analysis_notes)}</p></div>` : ''}
                    ${ev.llm_response ? `<div class="eval-section"><div class="eval-section-label">LLM Response</div><pre>${escapeHtml(ev.llm_response)}</pre></div>` : ''}
                </div>
            </div>`;
        });
        accordionHTML += '</div>';

        document.getElementById(containerId).innerHTML =
            heroHTML + metricsHTML + winrateHTML + sentimentHTML + categoryHTML + perceptionHTML + insightsHTML + accordionHTML;
    }

    // =============================================
    // Helpers
    // =============================================
    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    function extractDomain(url) {
        try { return new URL(url).hostname; } catch { return url; }
    }

    function directoriesMatch(dir1, dir2) {
        if (!dir1 || !dir2) return false;
        if (dir1 === dir2) return true;
        const n1 = dir1.replace(/\/+$/, '');
        const n2 = dir2.replace(/\/+$/, '');
        return n1 === n2 || n1.endsWith('/' + n2) || n2.endsWith('/' + n1);
    }

    function showEl(id) { document.getElementById(id).classList.remove('hidden'); }
    function hideEl(id) { document.getElementById(id).classList.add('hidden'); }

    function showErrorText(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.classList.remove('hidden');
    }

    function updateStatusText(id, text) {
        document.getElementById(id).innerHTML = '<span class="spinner"></span>' + escapeHtml(text);
    }

    function updateFillWidth(id, pct) {
        document.getElementById(id).style.width = pct + '%';
    }

    // =============================================
    // Expose functions for onclick in dynamic HTML
    // =============================================
    window.switchTab = switchTab;
    window.addWebsite = addWebsite;
    window.removeSite = removeSite;
    window.startCrawlForSite = startCrawlForSite;
    window.startAnalysisForSite = startAnalysisForSite;
    window.deleteAnalysis = deleteAnalysis;
    window.startBenchmarkNew = startBenchmarkNew;
    window.loadExistingBenchmarkNew = loadExistingBenchmarkNew;
    window.deleteBenchmark = deleteBenchmark;
    window.onReportTypeChange = onReportTypeChange;
    window.onReportSelected = onReportSelected;
    window.downloadCurrentReport = downloadCurrentReport;

    // =============================================
    // Init
    // =============================================
    loadSitesFromAPI();
    refreshAnalysesList();
    refreshBenchmarksList();
</script>
</body>
</html>
