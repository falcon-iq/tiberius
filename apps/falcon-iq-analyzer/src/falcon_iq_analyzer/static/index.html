<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon IQ Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        h1 { text-align: center; margin-bottom: 8px; color: #1a1a2e; }
        .subtitle { text-align: center; color: #666; margin-bottom: 32px; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }
        .card h2 { font-size: 18px; margin-bottom: 16px; color: #1a1a2e; }
        .card h2 .step { color: #666; font-weight: normal; font-size: 13px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #555; }
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: #4a6cf7; }
        .row { display: flex; gap: 12px; align-items: flex-end; }
        .row > * { flex: 1; }
        .row > .small { flex: 0 0 120px; }
        button {
            background: #4a6cf7;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }
        button:hover { background: #3a5ce5; }
        button:disabled { background: #b0b8d1; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .divider {
            text-align: center;
            color: #999;
            font-size: 13px;
            margin: 16px 0;
            position: relative;
        }
        .divider::before, .divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        .progress-bar {
            background: #e9ecef;
            border-radius: 8px;
            height: 8px;
            margin: 12px 0;
            overflow: hidden;
        }
        .progress-bar .fill {
            background: #4a6cf7;
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s;
            width: 0%;
        }
        .status-text {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 8px;
        }
        .error { color: #dc3545; font-size: 13px; margin-top: 8px; }
        .site-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .site-info strong { color: #1a1a2e; }
        .hidden { display: none; }
        .report-content {
            font-size: 14px;
            line-height: 1.7;
        }
        .report-content h1 { text-align: left; font-size: 24px; margin: 20px 0 12px; }
        .report-content h2 { font-size: 20px; margin: 20px 0 10px; color: #1a1a2e; }
        .report-content h3 { font-size: 16px; margin: 16px 0 8px; }
        .report-content table { width: 100%; border-collapse: collapse; margin: 12px 0; }
        .report-content th, .report-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
            font-size: 13px;
        }
        .report-content th { background: #f8f9fa; font-weight: 600; }
        .report-content ul, .report-content ol { padding-left: 24px; margin: 8px 0; }
        .report-content p { margin: 8px 0; }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-top-color: #4a6cf7;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 600px) {
            .row { flex-direction: column; }
            .row > .small { flex: 1; }
            body { padding: 12px; }
            .card { padding: 16px; }
        }

        /* --- Dashboard Variables --- */
        :root {
            --color-a: #4a6cf7;
            --color-b: #f7844a;
            --color-tie: #adb5bd;
        }

        /* --- Hero Winner Banner --- */
        .hero-banner {
            background: linear-gradient(135deg, #4a6cf7, #7c3aed);
            color: #fff;
            border-radius: 12px;
            padding: 32px 24px;
            text-align: center;
            margin-bottom: 24px;
            animation: slideIn 0.6s ease-out;
        }
        .hero-banner .matchup { font-size: 14px; opacity: 0.85; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .hero-banner .scoreboard { font-size: 48px; font-weight: 800; margin: 12px 0; letter-spacing: 4px; }
        .hero-banner .winner-label { font-size: 20px; font-weight: 700; }
        .hero-banner .winner-label .trophy { font-size: 28px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Metric Cards --- */
        .metric-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .metric-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .metric-card .metric-value { font-size: 32px; font-weight: 800; color: #1a1a2e; }
        .metric-card .metric-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .metric-card .mini-bar { background: #e9ecef; border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; }
        .metric-card .mini-bar .mini-fill { height: 100%; border-radius: 4px; animation: growWidth 1s ease-out forwards; }
        @keyframes growWidth { from { width: 0%; } }

        /* --- Win Rate Bar --- */
        .winrate-bar-wrap { margin-bottom: 24px; }
        .winrate-bar-wrap h3 { font-size: 14px; color: #555; margin-bottom: 8px; font-weight: 600; }
        .winrate-bar { display: flex; height: 36px; border-radius: 8px; overflow: hidden; font-size: 12px; font-weight: 700; color: #fff; }
        .winrate-bar .seg { display: flex; align-items: center; justify-content: center; transition: width 1s ease-out; }
        .winrate-bar .seg-a { background: var(--color-a); }
        .winrate-bar .seg-tie { background: var(--color-tie); }
        .winrate-bar .seg-b { background: var(--color-b); }
        .winrate-legend { display: flex; gap: 20px; margin-top: 8px; font-size: 12px; color: #666; }
        .winrate-legend span::before { content: ''; display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 6px; vertical-align: middle; }
        .winrate-legend .leg-a::before { background: var(--color-a); }
        .winrate-legend .leg-tie::before { background: var(--color-tie); }
        .winrate-legend .leg-b::before { background: var(--color-b); }

        /* --- Sentiment Gauges --- */
        .sentiment-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .sentiment-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .sentiment-card .sent-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .sentiment-card .sent-company { font-size: 16px; font-weight: 700; color: #1a1a2e; margin-bottom: 12px; }
        .sentiment-card .sent-value { font-size: 28px; font-weight: 800; margin-bottom: 10px; }
        .sent-track { background: #e9ecef; border-radius: 4px; height: 10px; position: relative; }
        .sent-fill { height: 100%; border-radius: 4px; position: absolute; top: 0; transition: width 1s ease-out; }
        .sent-marker { position: absolute; top: -3px; width: 4px; height: 16px; background: #1a1a2e; border-radius: 2px; transform: translateX(-50%); transition: left 1s ease-out; }

        /* --- Category Breakdown --- */
        .category-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 24px; }
        .category-table th { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; padding: 8px 12px; text-align: left; border-bottom: 2px solid #e9ecef; }
        .category-table td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .category-table .cat-name { font-weight: 600; color: #333; text-transform: capitalize; }
        .cat-mini-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; min-width: 120px; }
        .cat-mini-bar .cat-seg-a { background: var(--color-a); }
        .cat-mini-bar .cat-seg-b { background: var(--color-b); }

        /* --- Perception Panels --- */
        .perception-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .perception-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .perception-card h4 { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
        .perception-card .perc-section { margin-bottom: 10px; }
        .perception-card .perc-section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 6px; }
        .pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 2px 4px 2px 0; }
        .pill-green { background: #d4edda; color: #155724; }
        .pill-red { background: #f8d7da; color: #721c24; }

        /* --- Key Insights --- */
        .insights-box {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            border-radius: 0 10px 10px 0;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .insights-box .insights-header { font-size: 16px; font-weight: 700; color: #92400e; margin-bottom: 10px; }
        .insights-box ul { list-style: disc; padding-left: 20px; }
        .insights-box li { font-size: 14px; color: #78350f; margin-bottom: 6px; line-height: 1.5; }

        /* --- Accordion --- */
        .eval-accordion { margin-bottom: 24px; }
        .eval-item { background: #fff; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .eval-header {
            display: flex; align-items: center; gap: 10px; padding: 14px 18px;
            cursor: pointer; user-select: none; font-size: 14px;
        }
        .eval-header:hover { background: #f8f9fa; }
        .eval-header .eval-num { font-weight: 700; color: #555; min-width: 28px; }
        .eval-header .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-category { background: #e9ecef; color: #495057; }
        .badge-a { background: var(--color-a); color: #fff; }
        .badge-b { background: var(--color-b); color: #fff; }
        .badge-tie { background: var(--color-tie); color: #fff; }
        .eval-header .eval-prompt-preview { flex: 1; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .eval-header .chevron { font-size: 12px; color: #aaa; transition: transform 0.2s; }
        .eval-item.open .chevron { transform: rotate(90deg); }
        .eval-body { display: none; padding: 0 18px 18px; font-size: 13px; line-height: 1.7; }
        .eval-item.open .eval-body { display: block; }
        .eval-body .eval-section { margin-bottom: 12px; }
        .eval-body .eval-section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 4px; }
        .eval-body pre { background: #f5f7fa; border-radius: 8px; padding: 12px; overflow-x: auto; max-height: 300px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }

        /* --- Dashboard Responsive --- */
        @media (max-width: 700px) {
            .metric-cards { grid-template-columns: repeat(2, 1fr); }
            .sentiment-row, .perception-row { grid-template-columns: 1fr; }
            .hero-banner .scoreboard { font-size: 36px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Falcon IQ Analyzer</h1>
        <p class="subtitle">Crawl websites and analyze product offerings using AI</p>

        <!-- Step 1: Crawl -->
        <div class="card" id="step1">
            <h2><span class="step">Step 1 &mdash;</span> Select or Crawl a Site</h2>

            <label for="siteSelect">Previously crawled sites</label>
            <select id="siteSelect">
                <option value="">-- Loading sites... --</option>
            </select>

            <div class="divider">or crawl a new site</div>

            <div class="row">
                <div>
                    <label for="urlInput">Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com">
                </div>
                <div class="small">
                    <label for="maxPages">Max pages</label>
                    <input type="number" id="maxPages" value="100" min="1" max="10000">
                </div>
            </div>
            <button id="crawlBtn" onclick="startCrawl()">Crawl</button>

            <div id="crawlProgress" class="hidden">
                <div class="progress-bar"><div class="fill" id="crawlFill"></div></div>
                <p class="status-text" id="crawlStatus"><span class="spinner"></span>Starting...</p>
            </div>
            <p class="error hidden" id="crawlError"></p>
        </div>

        <!-- Step 2: Analyze -->
        <div class="card hidden" id="step2">
            <h2><span class="step">Step 2 &mdash;</span> Analyze</h2>

            <div class="site-info" id="siteInfoDisplay"></div>

            <label for="companyName">Company name</label>
            <input type="text" id="companyName" placeholder="Company name">

            <button id="analyzeBtn" onclick="startAnalysis()">Analyze</button>

            <div id="analyzeProgress" class="hidden">
                <div class="progress-bar"><div class="fill" id="analyzeFill"></div></div>
                <p class="status-text" id="analyzeStatus"><span class="spinner"></span>Starting...</p>
            </div>
            <p class="error hidden" id="analyzeError"></p>
        </div>

        <!-- Step 3: Report -->
        <div class="card hidden" id="step3">
            <h2><span class="step">Step 3 &mdash;</span> Report</h2>
            <div class="report-content" id="reportContent"></div>
            <br>
            <button class="btn-success" onclick="downloadReport()">Download Report</button>
        </div>

        <!-- Step 4: Benchmark -->
        <div class="card" id="step4">
            <h2><span class="step">Step 4 &mdash;</span> LLM Benchmark</h2>
            <p style="font-size:13px;color:#666;margin-bottom:16px;">Compare how LLMs perceive two companies. Requires two completed analyses.</p>

            <label for="benchSelect">Previous benchmarks</label>
            <select id="benchSelect" onchange="loadExistingBenchmark(this.value)">
                <option value="">-- Run a new benchmark --</option>
            </select>

            <div class="divider">or run a new benchmark</div>

            <div class="row">
                <div>
                    <label for="benchJobA">Company A</label>
                    <select id="benchJobA">
                        <option value="">-- Select analysis --</option>
                    </select>
                </div>
                <div>
                    <label for="benchJobB">Company B</label>
                    <select id="benchJobB">
                        <option value="">-- Select analysis --</option>
                    </select>
                </div>
                <div class="small">
                    <label for="numPrompts">Prompts</label>
                    <input type="number" id="numPrompts" value="15" min="1" max="50">
                </div>
            </div>
            <button id="benchmarkBtn" onclick="startBenchmark()">Run Benchmark</button>

            <div id="benchmarkProgress" class="hidden">
                <div class="progress-bar"><div class="fill" id="benchmarkFill"></div></div>
                <p class="status-text" id="benchmarkStatus"><span class="spinner"></span>Starting...</p>
            </div>
            <p class="error hidden" id="benchmarkError"></p>
        </div>

        <!-- Step 5: Benchmark Report Dashboard -->
        <div class="hidden" id="step5">
            <div id="benchmarkReportContent"></div>
            <div class="card">
                <button class="btn-success" onclick="downloadBenchmarkReport()">Download Benchmark Report (Markdown)</button>
            </div>
        </div>
    </div>

<script>
    let currentSite = null;   // { domain, directory, page_count }
    let analyzeJobId = null;
    let completedJobIds = [];  // track completed analysis job IDs for benchmark
    let benchmarkJobId = null;
    let benchmarkMarkdown = null;

    // --- Init ---
    loadSites();
    loadAnalyses();
    loadBenchmarksList();

    async function loadSites() {
        try {
            const res = await fetch('/sites');
            const sites = await res.json();
            const sel = document.getElementById('siteSelect');
            sel.innerHTML = '<option value="">-- Select a crawled site --</option>';
            sites.forEach(s => {
                const opt = document.createElement('option');
                opt.value = JSON.stringify(s);
                opt.textContent = `${s.domain} (${s.page_count} pages)`;
                sel.appendChild(opt);
            });
        } catch (e) {
            console.error('Failed to load sites', e);
            document.getElementById('siteSelect').innerHTML =
                '<option value="">-- No sites available --</option>';
        }
    }

    document.getElementById('siteSelect').addEventListener('change', function() {
        if (!this.value) return;
        const site = JSON.parse(this.value);
        selectSite(site);
    });

    function selectSite(site) {
        currentSite = site;
        document.getElementById('siteInfoDisplay').innerHTML =
            `<strong>${site.domain}</strong> &mdash; ${site.page_count} pages in <code>${site.directory}</code>`;
        document.getElementById('companyName').value =
            site.domain.replace(/^www\./, '').split('.')[0];
        show('step2');
        hide('step3');
    }

    // --- Crawl ---
    async function startCrawl() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) return alert('Please enter a URL');

        const maxPages = parseInt(document.getElementById('maxPages').value) || 100;
        const btn = document.getElementById('crawlBtn');
        btn.disabled = true;

        show('crawlProgress');
        hideError('crawlError');
        updateStatus('crawlStatus', 'Starting crawl...');
        updateFill('crawlFill', 5);

        try {
            const res = await fetch('/crawl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, max_pages: maxPages }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Crawl failed');

            pollCrawl(data.job_id, data.output_dir, maxPages);
        } catch (e) {
            showError('crawlError', e.message);
            btn.disabled = false;
            hide('crawlProgress');
        }
    }

    async function pollCrawl(jobId, outputDir, maxPages) {
        const poll = async () => {
            try {
                const res = await fetch(`/crawl/${jobId}`);
                const data = await res.json();

                const pct = Math.min(95, (data.page_count / maxPages) * 100);
                updateFill('crawlFill', data.status === 'completed' ? 100 : pct);
                updateStatus('crawlStatus', data.progress || data.status);

                if (data.status === 'completed') {
                    updateFill('crawlFill', 100);
                    document.getElementById('crawlBtn').disabled = false;

                    // Refresh sites list
                    await loadSites();

                    selectSite({
                        domain: extractDomain(document.getElementById('urlInput').value),
                        directory: outputDir,
                        page_count: data.page_count,
                    });
                    return;
                }
                if (data.status === 'failed') {
                    showError('crawlError', data.error || 'Crawl failed');
                    document.getElementById('crawlBtn').disabled = false;
                    hide('crawlProgress');
                    return;
                }

                setTimeout(poll, 2000);
            } catch (e) {
                showError('crawlError', e.message);
                document.getElementById('crawlBtn').disabled = false;
            }
        };
        setTimeout(poll, 2000);
    }

    // --- Analyze ---
    async function startAnalysis() {
        if (!currentSite) return;
        const companyName = document.getElementById('companyName').value.trim();
        if (!companyName) return alert('Please enter a company name');

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        show('analyzeProgress');
        hideError('analyzeError');
        hide('step3');
        updateStatus('analyzeStatus', 'Starting analysis...');
        updateFill('analyzeFill', 5);

        try {
            const res = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    crawl_directory: currentSite.directory,
                    company_name: companyName,
                }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Analysis failed');

            analyzeJobId = data.job_id;
            pollAnalysis(data.job_id);
        } catch (e) {
            showError('analyzeError', e.message);
            btn.disabled = false;
            hide('analyzeProgress');
        }
    }

    async function pollAnalysis(jobId) {
        const stepPattern = /step\s*(\d+)/i;

        const poll = async () => {
            try {
                const res = await fetch(`/analyze/${jobId}`);
                const data = await res.json();

                let pct = 10;
                const match = data.progress.match(stepPattern);
                if (match) pct = Math.min(95, (parseInt(match[1]) / 6) * 100);

                updateFill('analyzeFill', data.status === 'completed' ? 100 : pct);
                updateStatus('analyzeStatus', data.progress || data.status);

                if (data.status === 'completed') {
                    updateFill('analyzeFill', 100);
                    document.getElementById('analyzeBtn').disabled = false;

                    if (data.result && data.result.markdown_report) {
                        showReport(data.result.markdown_report);
                    }

                    // Refresh benchmark dropdowns with new analysis
                    await loadAnalyses();
                    return;
                }
                if (data.status === 'failed') {
                    showError('analyzeError', data.error || 'Analysis failed');
                    document.getElementById('analyzeBtn').disabled = false;
                    hide('analyzeProgress');
                    return;
                }

                setTimeout(poll, 3000);
            } catch (e) {
                showError('analyzeError', e.message);
                document.getElementById('analyzeBtn').disabled = false;
            }
        };
        setTimeout(poll, 3000);
    }

    // --- Report ---
    function showReport(markdown) {
        document.getElementById('reportContent').innerHTML = marked.parse(markdown);
        show('step3');
        document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
    }

    async function downloadReport() {
        if (!analyzeJobId) return;
        try {
            const res = await fetch(`/report/${analyzeJobId}`);
            if (!res.ok) throw new Error('Failed to download');
            const text = await res.text();
            const blob = new Blob([text], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `report-${analyzeJobId}.md`;
            a.click();
            URL.revokeObjectURL(a.href);
        } catch (e) {
            alert('Download failed: ' + e.message);
        }
    }

    // --- Benchmark ---
    async function loadAnalyses() {
        try {
            const res = await fetch('/analyses');
            const analyses = await res.json();
            const selA = document.getElementById('benchJobA');
            const selB = document.getElementById('benchJobB');
            const defaultOpt = '<option value="">-- Select analysis --</option>';
            selA.innerHTML = defaultOpt;
            selB.innerHTML = defaultOpt;
            analyses.forEach(a => {
                const optA = document.createElement('option');
                optA.value = a.job_id;
                optA.textContent = `${a.company_name} (${a.job_id})`;
                selA.appendChild(optA);
                const optB = document.createElement('option');
                optB.value = a.job_id;
                optB.textContent = `${a.company_name} (${a.job_id})`;
                selB.appendChild(optB);
            });
        } catch (e) {
            console.error('Failed to load analyses', e);
        }
    }

    async function loadBenchmarksList() {
        try {
            const res = await fetch('/benchmarks');
            const benchmarks = await res.json();
            const sel = document.getElementById('benchSelect');
            sel.innerHTML = '<option value="">-- Run a new benchmark --</option>';
            benchmarks.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.job_id;
                opt.textContent = `${b.company_a} vs ${b.company_b} (${b.total_prompts} prompts) â€” ${b.job_id}`;
                sel.appendChild(opt);
            });
        } catch (e) {
            console.error('Failed to load benchmarks list', e);
        }
    }

    async function loadExistingBenchmark(jobId) {
        if (!jobId) {
            hide('step5');
            return;
        }
        try {
            const res = await fetch(`/benchmark/${jobId}`);
            const data = await res.json();
            if (data.status === 'completed' && data.result) {
                benchmarkJobId = jobId;
                benchmarkMarkdown = data.result.markdown_report || '';
                if (data.result.summary) {
                    renderBenchmarkDashboard(data.result);
                } else {
                    document.getElementById('benchmarkReportContent').innerHTML = marked.parse(benchmarkMarkdown);
                }
                show('step5');
                document.getElementById('step5').scrollIntoView({ behavior: 'smooth' });
            }
        } catch (e) {
            alert('Failed to load benchmark: ' + e.message);
        }
    }

    async function startBenchmark() {
        const jobA = document.getElementById('benchJobA').value;
        const jobB = document.getElementById('benchJobB').value;
        if (!jobA || !jobB) return alert('Please select both analyses');

        const numPrompts = parseInt(document.getElementById('numPrompts').value) || 15;
        const btn = document.getElementById('benchmarkBtn');
        btn.disabled = true;
        show('benchmarkProgress');
        hideError('benchmarkError');
        hide('step5');
        updateStatus('benchmarkStatus', 'Starting benchmark...');
        updateFill('benchmarkFill', 5);

        try {
            const res = await fetch('/benchmark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ job_id_a: jobA, job_id_b: jobB, num_prompts: numPrompts }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Benchmark failed');

            benchmarkJobId = data.job_id;
            pollBenchmark(data.job_id, numPrompts);
        } catch (e) {
            showError('benchmarkError', e.message);
            btn.disabled = false;
            hide('benchmarkProgress');
        }
    }

    async function pollBenchmark(jobId, numPrompts) {
        const stepPattern = /Step\s+(\d+)\/(\d+)/;

        const poll = async () => {
            try {
                const res = await fetch(`/benchmark/${jobId}`);
                const data = await res.json();

                let pct = 10;
                const match = data.progress.match(stepPattern);
                if (match) pct = Math.min(95, (parseInt(match[1]) / parseInt(match[2])) * 100);

                updateFill('benchmarkFill', data.status === 'completed' ? 100 : pct);
                updateStatus('benchmarkStatus', data.progress || data.status);

                if (data.status === 'completed') {
                    updateFill('benchmarkFill', 100);
                    document.getElementById('benchmarkBtn').disabled = false;

                    if (data.result) {
                        benchmarkMarkdown = data.result.markdown_report || '';
                        if (data.result.summary) {
                            renderBenchmarkDashboard(data.result);
                        } else {
                            document.getElementById('benchmarkReportContent').innerHTML = marked.parse(benchmarkMarkdown);
                        }
                        show('step5');
                        document.getElementById('step5').scrollIntoView({ behavior: 'smooth' });
                        await loadBenchmarksList();
                    }
                    return;
                }
                if (data.status === 'failed') {
                    showError('benchmarkError', data.error || 'Benchmark failed');
                    document.getElementById('benchmarkBtn').disabled = false;
                    hide('benchmarkProgress');
                    return;
                }

                setTimeout(poll, 3000);
            } catch (e) {
                showError('benchmarkError', e.message);
                document.getElementById('benchmarkBtn').disabled = false;
            }
        };
        setTimeout(poll, 3000);
    }

    function downloadBenchmarkReport() {
        if (!benchmarkMarkdown) return;
        const blob = new Blob([benchmarkMarkdown], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `benchmark-${benchmarkJobId}.md`;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    // --- Benchmark Dashboard Renderer ---
    function renderBenchmarkDashboard(result) {
        const s = result.summary;
        const evals = result.evaluations || [];
        const cA = s.company_a;
        const cB = s.company_b;
        const total = s.total_prompts || 1;
        const aWins = s.company_a_wins;
        const bWins = s.company_b_wins;
        const ties = s.ties;
        const aPct = Math.round((aWins / total) * 100);
        const bPct = Math.round((bWins / total) * 100);
        const tPct = 100 - aPct - bPct;

        let winner, loser, winnerWins, loserWins;
        if (aWins > bWins) { winner = cA; loser = cB; winnerWins = aWins; loserWins = bWins; }
        else if (bWins > aWins) { winner = cB; loser = cA; winnerWins = bWins; loserWins = aWins; }
        else { winner = null; }

        // 1. Hero Banner
        let heroHTML = `<div class="hero-banner">
            <div class="matchup">${cA} vs ${cB}</div>
            <div class="scoreboard">${aWins} &mdash; ${bWins}</div>`;
        if (winner) {
            heroHTML += `<div class="winner-label"><span class="trophy">&#127942;</span> ${winner} WINS</div>`;
        } else {
            heroHTML += `<div class="winner-label">It's a Tie!</div>`;
        }
        heroHTML += `</div>`;

        // 2. Metric Cards
        const metricsHTML = `<div class="metric-cards">
            <div class="metric-card">
                <div class="metric-label">Total Prompts</div>
                <div class="metric-value">${total}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">${cA} Wins</div>
                <div class="metric-value" style="color:var(--color-a)">${aWins}</div>
                <div class="mini-bar"><div class="mini-fill" style="width:${aPct}%;background:var(--color-a)"></div></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">${cB} Wins</div>
                <div class="metric-value" style="color:var(--color-b)">${bWins}</div>
                <div class="mini-bar"><div class="mini-fill" style="width:${bPct}%;background:var(--color-b)"></div></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Ties</div>
                <div class="metric-value" style="color:var(--color-tie)">${ties}</div>
            </div>
        </div>`;

        // 3. Win Rate Bar
        const winrateHTML = `<div class="winrate-bar-wrap card">
            <h3>Win Rate Distribution</h3>
            <div class="winrate-bar">
                ${aPct > 0 ? `<div class="seg seg-a" style="width:${aPct}%">${aPct}%</div>` : ''}
                ${tPct > 0 ? `<div class="seg seg-tie" style="width:${tPct}%">${tPct}%</div>` : ''}
                ${bPct > 0 ? `<div class="seg seg-b" style="width:${bPct}%">${bPct}%</div>` : ''}
            </div>
            <div class="winrate-legend">
                <span class="leg-a">${cA}</span>
                <span class="leg-tie">Tie</span>
                <span class="leg-b">${cB}</span>
            </div>
        </div>`;

        // 4. Sentiment Comparison
        function sentimentColor(v) {
            if (v >= 0.5) return '#22c55e';
            if (v >= 0.2) return '#84cc16';
            if (v >= -0.2) return '#eab308';
            if (v >= -0.5) return '#f97316';
            return '#ef4444';
        }
        function sentimentGauge(company, value) {
            const pct = ((value + 1) / 2) * 100;
            const col = sentimentColor(value);
            return `<div class="sentiment-card">
                <div class="sent-label">Avg Sentiment</div>
                <div class="sent-company">${company}</div>
                <div class="sent-value" style="color:${col}">${value.toFixed(2)}</div>
                <div class="sent-track">
                    <div class="sent-fill" style="width:${pct}%;background:linear-gradient(90deg,#ef4444,#eab308,#22c55e);opacity:0.3"></div>
                    <div class="sent-marker" style="left:${pct}%"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:11px;color:#aaa;margin-top:4px"><span>-1.0</span><span>0</span><span>+1.0</span></div>
            </div>`;
        }
        const sentimentHTML = `<div class="sentiment-row">
            ${sentimentGauge(cA, s.company_a_avg_sentiment)}
            ${sentimentGauge(cB, s.company_b_avg_sentiment)}
        </div>`;

        // 5. Category Breakdown
        const categories = {};
        evals.forEach(ev => {
            const cat = ev.category || 'other';
            if (!categories[cat]) categories[cat] = { a: 0, b: 0, total: 0 };
            categories[cat].total++;
            if (ev.winner === 'company_a') categories[cat].a++;
            else if (ev.winner === 'company_b') categories[cat].b++;
        });
        let catRows = '';
        for (const [cat, counts] of Object.entries(categories)) {
            const catTotal = counts.total || 1;
            const aW = Math.round((counts.a / catTotal) * 100);
            const bW = Math.round((counts.b / catTotal) * 100);
            catRows += `<tr>
                <td class="cat-name">${cat.replace(/_/g, ' ')}</td>
                <td>${counts.total}</td>
                <td>${counts.a}</td>
                <td>${counts.b}</td>
                <td><div class="cat-mini-bar">
                    <div class="cat-seg-a" style="width:${aW}%"></div>
                    <div class="cat-seg-b" style="width:${bW}%"></div>
                </div></td>
            </tr>`;
        }
        const categoryHTML = `<div class="card">
            <h3 style="font-size:14px;color:#555;margin-bottom:8px;font-weight:600">Category Breakdown</h3>
            <table class="category-table">
                <thead><tr><th>Category</th><th>Prompts</th><th>${cA}</th><th>${cB}</th><th>Distribution</th></tr></thead>
                <tbody>${catRows}</tbody>
            </table>
        </div>`;

        // 6. Perception Panels
        function pillList(items, cls) {
            if (!items || items.length === 0) return '<span style="font-size:12px;color:#aaa">None noted</span>';
            return items.map(i => `<span class="pill ${cls}">${i}</span>`).join('');
        }
        const perceptionHTML = `<div class="perception-row">
            <div class="perception-card" style="border-top:3px solid var(--color-a)">
                <h4 style="color:var(--color-a)">${cA}</h4>
                <div class="perc-section">
                    <div class="perc-section-label">Strengths</div>
                    ${pillList(s.company_a_top_strengths, 'pill-green')}
                </div>
                <div class="perc-section">
                    <div class="perc-section-label">Weaknesses</div>
                    ${pillList(s.company_a_top_weaknesses, 'pill-red')}
                </div>
            </div>
            <div class="perception-card" style="border-top:3px solid var(--color-b)">
                <h4 style="color:var(--color-b)">${cB}</h4>
                <div class="perc-section">
                    <div class="perc-section-label">Strengths</div>
                    ${pillList(s.company_b_top_strengths, 'pill-green')}
                </div>
                <div class="perc-section">
                    <div class="perc-section-label">Weaknesses</div>
                    ${pillList(s.company_b_top_weaknesses, 'pill-red')}
                </div>
            </div>
        </div>`;

        // 7. Key Insights
        let insightsHTML = '';
        if (s.key_insights && s.key_insights.length > 0) {
            insightsHTML = `<div class="insights-box">
                <div class="insights-header">&#128161; Key Insights</div>
                <ul>${s.key_insights.map(i => `<li>${i}</li>`).join('')}</ul>
            </div>`;
        }

        // 8. Detailed Evaluations Accordion
        let accordionHTML = '<div class="eval-accordion"><h3 style="font-size:14px;color:#555;margin-bottom:12px;font-weight:600">Detailed Evaluations</h3>';
        evals.forEach((ev, idx) => {
            const winBadge = ev.winner === 'company_a' ? `<span class="badge badge-a">${cA}</span>`
                : ev.winner === 'company_b' ? `<span class="badge badge-b">${cB}</span>`
                : `<span class="badge badge-tie">Tie</span>`;

            const mA = ev.company_a_mention || {};
            const mB = ev.company_b_mention || {};

            accordionHTML += `<div class="eval-item">
                <div class="eval-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="eval-num">#${idx + 1}</span>
                    <span class="badge badge-category">${(ev.category || '').replace(/_/g, ' ')}</span>
                    ${winBadge}
                    <span class="eval-prompt-preview">${escapeHtml(ev.prompt_text || '')}</span>
                    <span class="chevron">&#9654;</span>
                </div>
                <div class="eval-body">
                    <div class="eval-section">
                        <div class="eval-section-label">Prompt</div>
                        <p>${escapeHtml(ev.prompt_text || '')}</p>
                    </div>
                    <div class="eval-section" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div>
                            <div class="eval-section-label">${cA} Sentiment</div>
                            <strong style="color:${sentimentColor(mA.sentiment || 0)}">${(mA.sentiment || 0).toFixed(2)}</strong>
                            ${mA.strengths_mentioned && mA.strengths_mentioned.length ? '<br>' + mA.strengths_mentioned.map(s => `<span class="pill pill-green">${s}</span>`).join('') : ''}
                            ${mA.weaknesses_mentioned && mA.weaknesses_mentioned.length ? '<br>' + mA.weaknesses_mentioned.map(s => `<span class="pill pill-red">${s}</span>`).join('') : ''}
                        </div>
                        <div>
                            <div class="eval-section-label">${cB} Sentiment</div>
                            <strong style="color:${sentimentColor(mB.sentiment || 0)}">${(mB.sentiment || 0).toFixed(2)}</strong>
                            ${mB.strengths_mentioned && mB.strengths_mentioned.length ? '<br>' + mB.strengths_mentioned.map(s => `<span class="pill pill-green">${s}</span>`).join('') : ''}
                            ${mB.weaknesses_mentioned && mB.weaknesses_mentioned.length ? '<br>' + mB.weaknesses_mentioned.map(s => `<span class="pill pill-red">${s}</span>`).join('') : ''}
                        </div>
                    </div>
                    ${ev.analysis_notes ? `<div class="eval-section"><div class="eval-section-label">Analysis Notes</div><p>${escapeHtml(ev.analysis_notes)}</p></div>` : ''}
                    ${ev.llm_response ? `<div class="eval-section"><div class="eval-section-label">LLM Response</div><pre>${escapeHtml(ev.llm_response)}</pre></div>` : ''}
                </div>
            </div>`;
        });
        accordionHTML += '</div>';

        document.getElementById('benchmarkReportContent').innerHTML =
            heroHTML + metricsHTML + winrateHTML + sentimentHTML + categoryHTML + perceptionHTML + insightsHTML + accordionHTML;
    }

    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    // --- Helpers ---
    function extractDomain(url) {
        try { return new URL(url).hostname; } catch { return url; }
    }
    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }
    function showError(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.classList.remove('hidden');
    }
    function hideError(id) { document.getElementById(id).classList.add('hidden'); }
    function updateStatus(id, text) {
        document.getElementById(id).innerHTML = '<span class="spinner"></span>' + text;
    }
    function updateFill(id, pct) {
        document.getElementById(id).style.width = pct + '%';
    }
</script>
</body>
</html>
